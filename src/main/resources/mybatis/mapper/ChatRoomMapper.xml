<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yoim.www.mapper.ChatRoomMapper">

	<insert id="insertRoom" parameterType="map"
        useGeneratedKeys="true" keyProperty="roomId" keyColumn="room_id">
	  INSERT INTO tb_chat_room (room_type, room_name, created_by)
	  VALUES (#{roomType}, #{roomName}, #{createdBy})
	</insert>
	
	<select id="lastInsertId" resultType="long">
		SELECT LAST_INSERT_ID()
	</select>
	
	<update id="incLastSeq">
		UPDATE tb_chat_room SET last_seq=last_seq+1,
		last_msg_at=NOW() WHERE room_id=#{roomId}
	</update>
		
	<select id="getLastSeq" resultType="int">
		SELECT last_seq FROM
		tb_chat_room WHERE room_id=#{roomId}
	</select>

	<!-- 방 목록 + unread -->
	<select id="listRoomsForUser" resultType="map">
	  SELECT r.room_id, r.room_type, r.room_name, r.last_seq,
	         GREATEST(r.last_seq - cm.last_read_seq, 0) AS unread,
	         r.last_msg_at
	  FROM tb_chat_room r
	  JOIN tb_chat_member cm
	    ON cm.room_id = r.room_id
	  WHERE cm.user_id = #{userId}
	  ORDER BY (r.last_msg_at IS NULL), r.last_msg_at DESC
	</select>


</mapper>
